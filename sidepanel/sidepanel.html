<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI对话监控助手</title>
  <link rel="stylesheet" href="sidepanel.css">
  <link rel="stylesheet" href="../lib/highlight-github.min.css">
</head>
<body>
  <!-- 顶部标题栏 -->
  <header class="header">
    <div class="header-top">
      <h1>🤖 AI对话监控</h1>
      <div class="header-actions">
        <button class="icon-btn" id="refreshBtn" title="刷新数据">🔄</button>
        <button class="icon-btn" id="settingsBtn" title="设置">⚙️</button>
      </div>
    </div>
    <div class="status-bar">
      <div class="status" id="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">监控中</span>
      </div>
      <span class="api-badge" id="apiBadge">检查中...</span>
    </div>
  </header>

  <!-- 主标签页导航（3个） -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="dashboard">📊 首页</button>
    <button class="tab-btn" data-tab="dialogue">💬 对话</button>
    <button class="tab-btn" data-tab="insights">🧠 洞察</button>
  </nav>

  <!-- 标签页内容 -->
  <main class="content">

    <!-- ====== 首页 ====== -->
    <section class="tab-panel active" id="tab-dashboard">
      <div class="stats-grid">
        <div class="stat-card stat-total">
          <div class="stat-icon">💬</div>
          <div class="stat-info">
            <div class="stat-value" id="totalMessages">0</div>
            <div class="stat-label">总消息</div>
          </div>
        </div>
        <div class="stat-card stat-ai">
          <div class="stat-icon">🤖</div>
          <div class="stat-info">
            <div class="stat-value" id="aiMessages">0</div>
            <div class="stat-label">AI回复</div>
          </div>
        </div>
        <div class="stat-card stat-user">
          <div class="stat-icon">👤</div>
          <div class="stat-info">
            <div class="stat-value" id="userMessages">0</div>
            <div class="stat-label">我的消息</div>
          </div>
        </div>
        <div class="stat-card stat-words">
          <div class="stat-icon">📝</div>
          <div class="stat-info">
            <div class="stat-value" id="totalWords">0</div>
            <div class="stat-label">总字数</div>
          </div>
        </div>
      </div>

      <div class="section-card">
        <h3>📡 平台状态</h3>
        <div class="platform-health" id="platformHealth">
          <div class="empty-hint">加载中...</div>
        </div>
      </div>

      <div class="section-card">
        <h3>📅 最近消息</h3>
        <div class="recent-messages" id="recentMessages">
          <div class="empty-hint">暂无消息</div>
        </div>
      </div>

      <div class="section-card">
        <h3>🔔 每日提醒</h3>
        <div class="reminder-settings">
          <div class="reminder-row">
            <span>每日学习提醒</span>
            <label class="switch">
              <input type="checkbox" id="reminderToggle" checked>
              <span class="switch-slider"></span>
            </label>
          </div>
          <div class="reminder-row">
            <span>提醒时间</span>
            <input type="time" id="reminderTime" value="20:00" class="time-input">
          </div>
        </div>
      </div>
    </section>

    <!-- ====== 对话（消息 + 搜索 + 导出） ====== -->
    <section class="tab-panel" id="tab-dialogue">
      <!-- 搜索栏（始终可见） -->
      <div class="search-toolbar">
        <div class="search-bar">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" class="search-input" placeholder="搜索所有对话记录...">
          <button class="search-clear" id="searchClear" title="清除">✕</button>
        </div>
        <div class="search-filters">
          <select id="searchPlatform" class="filter-select filter-sm">
            <option value="all">全部平台</option>
            <option value="chatgpt">ChatGPT</option>
            <option value="claude">Claude</option>
            <option value="copilot">Copilot</option>
            <option value="gemini">Gemini</option>
            <option value="deepseek">DeepSeek</option>
            <option value="perplexity">Perplexity</option>
          </select>
          <select id="searchRole" class="filter-select filter-sm">
            <option value="all">全部角色</option>
            <option value="user">我的消息</option>
            <option value="assistant">AI回复</option>
          </select>
        </div>
      </div>

      <!-- 搜索结果区（有搜索时显示） -->
      <div class="search-results" id="searchResults" style="display:none;"></div>

      <!-- 日期消息列表（无搜索时显示） -->
      <div id="messagesSection">
        <div class="messages-toolbar">
          <input type="date" id="dateSelector" class="date-input">
          <select id="platformFilter" class="filter-select filter-sm">
            <option value="all">全部平台</option>
            <option value="chatgpt">ChatGPT</option>
            <option value="claude">Claude</option>
            <option value="copilot">Copilot</option>
            <option value="gemini">Gemini</option>
            <option value="deepseek">DeepSeek</option>
            <option value="perplexity">Perplexity</option>
          </select>
          <select id="roleFilter" class="filter-select filter-sm">
            <option value="all">全部角色</option>
            <option value="user">我的消息</option>
            <option value="assistant">AI回复</option>
          </select>
          <button class="icon-btn add-btn" id="manualAddBtn" title="手动添加对话">➕</button>
        </div>
        <div class="messages-list" id="messagesList">
          <div class="empty-hint">选择日期查看消息</div>
        </div>

        <!-- 导出区域（折叠式，在消息列表下方） -->
        <details class="export-details">
          <summary class="export-details-summary">📦 上下文导出 — 选取对话片段复制到其他大模型</summary>
          <div class="export-details-body">
            <div class="export-filter section-card">
              <div class="export-dates">
                <div class="export-date-field">
                  <label>开始</label>
                  <input type="date" id="exportDateFrom" class="date-input">
                </div>
                <span class="date-arrow">→</span>
                <div class="export-date-field">
                  <label>结束</label>
                  <input type="date" id="exportDateTo" class="date-input">
                </div>
              </div>
              <div class="export-platforms" id="exportPlatforms">
                <label class="platform-check"><input type="checkbox" value="chatgpt" checked><span>ChatGPT</span></label>
                <label class="platform-check"><input type="checkbox" value="claude" checked><span>Claude</span></label>
                <label class="platform-check"><input type="checkbox" value="gemini" checked><span>Gemini</span></label>
                <label class="platform-check"><input type="checkbox" value="copilot" checked><span>Copilot</span></label>
                <label class="platform-check"><input type="checkbox" value="deepseek" checked><span>DeepSeek</span></label>
                <label class="platform-check"><input type="checkbox" value="perplexity" checked><span>Perplexity</span></label>
              </div>
              <div class="export-keyword-row">
                <input type="text" id="exportKeyword" class="search-input export-keyword" placeholder="关键词过滤（可选）">
                <button class="btn btn-ai btn-query" id="exportQueryBtn">🔍 查询</button>
              </div>
            </div>
            <div class="export-results" id="exportResults">
              <div class="empty-hint"><p>选择日期范围后点击「查询」</p></div>
            </div>
            <div class="export-actions" id="exportActions" style="display: none;">
              <div class="export-stats" id="exportStats"></div>
              <div class="export-format">
                <label class="radio-label"><input type="radio" name="exportFormat" value="conversation" checked> 对话格式</label>
                <label class="radio-label"><input type="radio" name="exportFormat" value="markdown"> Markdown</label>
                <label class="radio-label"><input type="radio" name="exportFormat" value="compact"> 精简</label>
              </div>
              <div class="export-options">
                <label class="check-label"><input type="checkbox" id="exportAddGuide" checked> 添加引导语</label>
              </div>
              <div class="export-buttons">
                <button class="btn btn-ai" id="exportCopyBtn">📋 复制到剪贴板</button>
                <button class="btn btn-outline btn-sm" id="exportDownloadBtn">📥 下载</button>
              </div>
              <div class="export-preview-toggle">
                <button class="btn-link" id="exportPreviewToggle">👁 预览</button>
              </div>
              <div class="export-preview" id="exportPreview" style="display: none;">
                <pre class="export-preview-text" id="exportPreviewText"></pre>
              </div>
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- ====== 洞察（总结 + 图谱 + 导出 合并） ====== -->
    <section class="tab-panel" id="tab-insights">
      <!-- 二级标签 -->
      <div class="insights-sub-tabs">
        <button class="insights-sub-btn active" data-sub="summary">📝 总结</button>
        <button class="insights-sub-btn" data-sub="graph">🧠 图谱</button>
      </div>

      <!-- 子页：AI总结 -->
      <div class="insights-sub active" id="sub-summary">
        <div class="summary-toolbar">
          <input type="date" id="summaryDate" class="date-input">
          <div class="summary-actions">
            <button class="btn btn-ai" id="generateSummary">🤖 生成总结</button>
            <button class="btn btn-outline btn-sm" id="regenerateSummary" style="display: none;">🔄 重新生成</button>
          </div>
        </div>
        <div class="summary-result" id="summaryResult">
          <div class="empty-hint">
            <div class="empty-icon">📝</div>
            <p>点击「生成总结」让AI分析你今天的对话</p>
            <p class="empty-sub">需要先配置API Key</p>
          </div>
        </div>
      </div>

      <!-- 子页：知识图谱 -->
      <div class="insights-sub" id="sub-graph">
        <div class="graph-sub-tabs">
          <button class="graph-sub-btn active" data-view="topics">📅 每日主题</button>
          <button class="graph-sub-btn" data-view="timeline">📈 时间线</button>
          <button class="graph-sub-btn" data-view="knowledge">🕸️ 知识图谱</button>
        </div>

        <div class="graph-scope">
          <button class="scope-btn active" data-scope="today">今日</button>
          <button class="scope-btn" data-scope="week">本周</button>
          <button class="scope-btn" data-scope="month">本月</button>
          <button class="scope-btn" data-scope="custom">自定义</button>
          <div class="scope-custom" id="graphCustomRange" style="display:none;">
            <input type="date" id="graphDateFrom" class="date-input date-sm">
            <span>→</span>
            <input type="date" id="graphDateTo" class="date-input date-sm">
          </div>
        </div>

        <div class="graph-actions-bar">
          <button class="btn btn-ai" id="graphGenerateBtn">✨ 生成分析</button>
          <select id="graphDirection" class="filter-select filter-sm" title="图谱方向">
            <option value="TD">↓ 上下</option>
            <option value="LR">→ 左右</option>
          </select>
        </div>

        <div class="graph-view active" id="view-topics">
          <div class="graph-placeholder">
            <div class="empty-icon">📅</div>
            <p>点击「生成分析」提取每日学习主题</p>
            <p class="empty-sub">LLM 会自动分析对话并提炼主题、标签、深度</p>
          </div>
        </div>
        <div class="graph-view" id="view-timeline">
          <div class="graph-placeholder">
            <div class="empty-icon">📈</div>
            <p>生成分析后可查看学习时间线</p>
          </div>
        </div>
        <div class="graph-view" id="view-knowledge">
          <div class="graph-placeholder">
            <div class="empty-icon">🕸️</div>
            <p>生成分析后可查看知识图谱</p>
          </div>
        </div>

        <div class="graph-toolbar" id="graphToolbar" style="display:none;">
          <button class="btn-icon-sm" id="graphCopyMermaid" title="复制 Mermaid 代码">📋 代码</button>
          <button class="btn-icon-sm" id="graphDownloadSvg" title="下载 SVG">📥 SVG</button>
          <button class="btn-icon-sm" id="graphZoomIn" title="放大">🔍+</button>
          <button class="btn-icon-sm" id="graphZoomOut" title="缩小">🔍−</button>
          <button class="btn-icon-sm" id="graphZoomReset" title="重置缩放">↺</button>
        </div>
      </div>

    </section> <!-- /tab-insights -->

  </main>

  <!-- 手动添加对话弹窗 -->
  <div class="modal-overlay" id="manualModal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>➕ 手动添加对话</h3>
        <button class="modal-close" id="modalClose">✕</button>
      </div>
      <div class="modal-body">
        <p class="modal-hint">当自动抓取失效时，可以手动粘贴对话内容。每行一条消息，支持格式：</p>
        <div class="format-hint">
          <code>用户: 你的问题</code><br>
          <code>AI: AI的回答</code>
        </div>
        <div class="modal-field">
          <label>平台</label>
          <select id="manualPlatform" class="filter-select">
            <option value="chatgpt">ChatGPT</option>
            <option value="claude">Claude</option>
            <option value="copilot">Copilot</option>
            <option value="gemini">Gemini</option>
            <option value="deepseek">DeepSeek</option>
            <option value="perplexity">Perplexity</option>
            <option value="other">其他</option>
          </select>
        </div>
        <div class="modal-field">
          <label>对话内容</label>
          <textarea id="manualContent" class="manual-textarea" rows="10"
            placeholder="用户: 什么是React Hooks?&#10;AI: React Hooks是React 16.8引入的新特性...&#10;用户: 怎么用useEffect?&#10;AI: useEffect是一个副作用Hook..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="modalCancel">取消</button>
        <button class="btn btn-ai" id="modalSave">💾 保存</button>
      </div>
    </div>
  </div>

  <script src="../lib/marked.min.js"></script>
  <script src="../lib/highlight.min.js"></script>
  <script src="../lib/mermaid.min.js"></script>
  <script src="../lib/llm-stream.js"></script>
  <script src="sidepanel.js"></script>
</body>
</html>
